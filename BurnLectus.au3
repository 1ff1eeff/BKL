#RequireAdmin  						;для функции BlockInput()
#include <WinAPISys.au3>			;для функции _WinAPI_SetKeyboardLayout()
$iLanguage 		= '0x0409'			;U.S. раскладка клавиатуры


;Для определения имени полей и кнопок используем "Autoit Window Info x86"
;распологается по адресу C:\Program Files (x86)\AutoIt3\Au3Info.exe
$exeName		= "keygen.exe"		;путь к исполняемому файлу приложения создающего ключи
$mainFrame  	= "Генератор ключа" ;заголовок окна приложения создающего ключи
$textBox1 		= "[NAME:textBox1]" ;имена текстовых полей ввода
$textBox2 		= "[NAME:textBox2]" ;имена текстовых полей ввода
$genBtnText 	= "Создать ключ"	;надпись на кнопке генерации ключа
$genBtnName 	= "[NAME:button1]"	;имя кнопки генерации ключа
$someNumber 	= "301800" 			;какое-то число
$orgName 		= "Pochtamt" 		;название организации
$keyFile		= "keyfile"			;имя файла с ключом
$archName		= "archKey.exe"		;имя для будущего sfx-архива
$programDir		= "Lectus\key" 		;каталог назначения для архива с ключом

$neroExe		= "C:\Program Files (x86)\Nero\Nero 2017\Nero Burning ROM\nero.exe"  	;путь к исполняемому файлу
$neroWnd		= "Nero Burning ROM"													;класс или заголовок окна
$lectusDir 		= "C:\Users\1ff1e\Desktop\autoit\Lectus"								;папка которую будем писать на оптический диск
$neroNPWnd 		= "Новый проект"	;заголовок окна создания нового проекта
$neroNPBtn 		= "Button52"		;имя класса кнопки создания нового проекта
$neroNPBtnText 	= "Новый"			;текст кнопки создания нового проекта
$neroNPBtnID	= "[ID:6184]"   	;ID кнопки создания нового проекта
$neroAddWnd 	= "Добавить файлы и папки"				;заголовок окна добавления файлов в проект
$neroAddClass	= "[CLASS:DirectUIHWND; INSTANCE:2]"	;класс поля выбора файлов
$neroAddBtnN	= "Добавить"							;имя кнопки добавления файлов в проект
$neroAddBtnT	= "[CLASS:Button; INSTANCE:1]"			;класс кнопки добавления файлов в проект

;Скрипт принимает параметры командной строки в формате: "-аргумент значение"
;Например строка запуска для всех значений по умолчанию
;Script.exe -exeName keygen.exe -mainFrame "Генератор ключа" -textBox1 [NAME:textBox1] -textBox2 [NAME:textBox2]
;			-genBtnText "Создать ключ" -genBtnName [NAME:button1] -someNumber 301832 -orgName Pochtamt -keyFile keyfile
;			-archName archKey.exe -programDir C:\Users\1ff1e\Desktop\autoit\new

For $i = 1 To $CmdLine[0]
   Switch $CmdLine[$i]
	Case "-someNumber"
	  $someNumber 	= $CmdLine[$i+1]
	Case "-orgName"
	  $orgName 		= $CmdLine[$i+1]
	Case "-keyFile"
	  $keyFile 		= $CmdLine[$i+1]
	Case "-archName"
	  $archName 	= $CmdLine[$i+1]
	Case "-programDir"
	  $programDir	= $CmdLine[$i+1]
   EndSwitch
Next

;Запуск генератора - указать имя (и адрес если не в рабочей папке)!
Run($exeName)
   ;Отключаем ввод с клавиатуры и мыши
   BlockInput(1)
   ;Запускаем генератор ключа
   $hWnd = WinWait($mainFrame, "", 1)
   If Not $hWnd Then
	  BlockInput(0)
	  MsgBox(0, 'Внимание!', "Кейген не найден!")
	  Exit
   EndIf
   ;Вводим данные в текстовые поля
   ControlSend($hWnd, "", $textBox1, $someNumber)
   ControlSend($hWnd, "", $textBox2, $orgName)
   ;Жмем генерацию
   ControlClick($hWnd, $genBtnText, $genBtnName)
   ;Закрытие
   WinClose($hWnd)
   ;Создаём sfx-архив
   ;Требуются файлы 7z.sfx и 7za.exe в папке скрипта
   RunWait(@ComSpec & " /c " & "7za.exe a -sfx7z.sfx " & $archName & " " & $keyFile)
   If FileExists($programDir) Then
	  FileCopy($archName, $programDir & "\*.*") ;Копируем полученый архив в папку программы
	  FileDelete ($archName)					;и удаляем его из рабочей папки
	  FileDelete ($keyFile)						;также удаляем файл ключа из рабочей папки
   Else
	  DirCreate($programDir)					;Создаём каталог если его нет по указанному адресу
	  FileCopy($archName, $programDir & "\*.*") ;Копируем полученый архив в папку программы
	  FileDelete ($archName)					;и удаляем его из рабочей папки
	  FileDelete ($keyFile)						;также удаляем файл ключа из рабочей папки
   EndIf

   ;Возвращаем ввод с клавиатуры и мыши(необязательно)
   BlockInput(0)

Run($neroExe)

   ;Отключаем ввод с клавиатуры и мыши
   BlockInput(1)

   ;Запускаем Nero Burning ROM
   $hWnd = WinWait($neroWnd, "", 1)
   If Not $hWnd Then
	  BlockInput(0)
	  MsgBox(4096, 'Внимание!', "Nero не найден!")
	  Exit
   EndIf

   ControlClick($hWnd, $neroNPWnd, $neroNPBtn)

   ; Ожидаем окно "Новый проект"
   $hWnd = WinWaitActive($neroNPWnd, "", 5)
   If Not $hWnd Then
	  BlockInput(0)
	  MsgBox(4096, 'Сообщение', 'Окно не найдено, завершаем работу скрипта')
	  Exit
   EndIf
   ControlClick($neroNPWnd, $neroNPBtnText, $neroNPBtnID)

   ; Ожидаем окно $neroWnd
   $hWnd = WinWaitActive($neroWnd, "", 5)
   If Not $hWnd Then
	  BlockInput(0)
	  MsgBox(4096, 'Сообщение', 'Окно не найдено, завершаем работу скрипта')
	  Exit
   EndIf
   Sleep(1000)
   Send("{APPSKEY}")
   Send("{UP 4}")
   Send("{ENTER}")
   Send($lectusDir)
   Send("{ENTER}")
   ; Ожидаем окно "Добавить файлы и папки"
   $hWnd = WinWaitActive($neroAddWnd, "", 5)
   If Not $hWnd Then
	  BlockInput(0)
	  MsgBox(4096, 'Сообщение', 'Окно не найдено, завершаем работу скрипта')
	  Exit
   EndIf
   ControlClick($neroAddWnd, "", $neroAddClass)
   Sleep(1000)
   Send("{CTRLDOWN}")
   Sleep(100)
   Send("{a}")
   Sleep(1000)
   Send("{CTRLUP}")

   ; Ожидаем окно "Добавить файлы и папки"
   $hWnd = WinWaitActive($neroAddWnd, "", 5)
   If Not $hWnd Then
	  BlockInput(0)
	  MsgBox(4096, 'Сообщение', 'Окно не найдено, завершаем работу скрипта')
	  Exit
   EndIf
   ControlClick($neroAddWnd, $neroAddBtnN, $neroAddBtnT)
   Sleep(1000)
   Send("{CTRLDOWN}")
   Sleep(100)
   Send("{b}")
   Sleep(100)
   Send("{CTRLUP}")
   ;Sleep(3000)

   ; Ожидаем окно "Записать проект"
   ;$hWnd = WinWaitActive("Записать проект", "", 5)
   ;If Not $hWnd Then
   ;	BlockInput(0)
   ;	MsgBox(4096, 'Сообщение', 'Окно не найдено, завершаем работу скрипта')
   ;	Exit
   ;EndIf
   ;ControlClick("Записать проект", "Прожиг", "[CLASS:Button; INSTANCE:52]")
   ;Sleep(1000)
   ;Закрытие
   ;WinClose($hWnd)
   ;Sleep(1000)
   ;ControlClick("Сохранить проект", "Нет", "[CLASS:Button; INSTANCE:3]")

   ;Возвращаем ввод с клавиатуры и мыши(необязательно)
   BlockInput(0)

Exit